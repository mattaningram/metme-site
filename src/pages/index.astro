---
import Layout from '@layouts/Layout.astro'
import MetMeDemo from '@components/MetMeDemo.astro'
import MetMeViewsDemo from '@components/MetMeViewsDemo.astro'
import { Image } from 'astro:assets'
import metmeIcon from '@media/metme/metme-ios-icon.png'
---

<Layout class="metme-page">
  <main class="mm">
    <!-- Hero -->
    <section class="mm-hero">
      <div class="mm-hero__icon">
        <Image src={metmeIcon} alt="MetMe App Icon" width={120} height={120} layout="constrained" loading="eager" />
      </div>
      <h1 class="mm-hero__title">metme</h1>
      <p class="mm-hero__sub">Remember everyone you meet.</p>
    </section>

    <!-- Problem -->
    <section class="mm-problem">
      <p class="mm-problem__text">
        You meet someone new. You get their name, maybe a phone number. Then you're tapping through the Contacts app,
        field after field, trying to remember details that are already fading. There's no place for context. No field for
        "where we met" or "what we talked about."
      </p>
      <p class="mm-problem__text">
        So you do what everyone does. Put "coffee shop" as their last name and hope for the best. MetMe gives you a
        better way.
      </p>
    </section>

    <!-- Scrollytelling -->
    <section class="mm-scroll" aria-label="How MetMe works">
      <div class="mm-scroll__inner">
        <!-- Text column -->
        <div class="mm-scroll__text-col">
          <div class="mm-scroll__step" data-step="demo-intro">
            <p class="mm-scroll__step-text">
              Say one sentence. "Met Sarah at the coffee shop, she's a designer at Figma." MetMe's on-device AI pulls
              out names, roles, companies, and contact info automatically.
            </p>
          </div>

          <div class="mm-scroll__step" data-step="demo-watch">
            <p class="mm-scroll__step-text">
              One sentence becomes a full contact card in seconds. No tapping through fields. No guessing what to put
              where.
            </p>
          </div>

          <div class="mm-scroll__step" data-step="views-intro">
            <p class="mm-scroll__step-text">
              MetMe automatically saves when and where you met alongside every contact. Three views help you put your
              contacts in context.
            </p>
          </div>

          <div class="mm-scroll__step" data-step="view-timeline">
            <h3 class="mm-scroll__step-title">Timeline</h3>
            <p class="mm-scroll__step-text">
              Scroll through everyone you've met, organized by day. See exactly when each connection started.
            </p>
          </div>

          <div class="mm-scroll__step" data-step="view-calendar">
            <h3 class="mm-scroll__step-title">Calendar</h3>
            <p class="mm-scroll__step-text">
              Zoom out and see the bigger picture. Which days were packed with new faces, which were quiet. Tap any date
              for the full list.
            </p>
          </div>

          <div class="mm-scroll__step" data-step="view-map">
            <h3 class="mm-scroll__step-title">Map</h3>
            <p class="mm-scroll__step-text">
              Remember that person from the conference in Austin? The map shows everyone pinned to where you met them.
            </p>
          </div>
        </div>

        <!-- Phone column -->
        <div class="mm-scroll__phone-col">
          <div class="mm-scroll__phone-sticky">
            <div class="mm-scroll__phone-layer" data-layer="demo">
              <MetMeDemo />
            </div>
            <div class="mm-scroll__phone-layer" data-layer="views">
              <MetMeViewsDemo />
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Features -->
    <section class="mm-features">
      <p class="mm-features__text">
        MetMe works offline. No internet, no servers, no cloud. Everything runs on your device using Apple Intelligence.
        No account to create, no login to remember. Just open the app and start talking. Your contacts go straight to iOS
        Contacts and never leave your phone.
      </p>
    </section>

    <div class="mm-bottom-gradient">
      <!-- Bottom CTA -->
      <section class="mm-bottom-cta">
        <div class="mm-bottom-cta__icon">
          <Image layout="constrained" src={metmeIcon} alt="MetMe" width={72} height={72} />
        </div>
        <p class="mm-bottom-cta__desc">Coming to the App Store soon!</p>
        <a
          href="https://testflight.apple.com/join/EQErxJEX"
          class="mm-cta-btn"
          data-visitors-event="Join Testflight"
          data-visitors-source="Bottom"
        >
          <span class="mm-cta-btn__label">Get MetMe on TestFlight</span>
        </a>
        <div class="mm-requirements__wrap">
          <span class="mm-requirements">iOS 26+</span><span class="mm-requirements">iPhone 15 Pro or newer</span>
        </div>
      </section>

      <!-- Footer -->
      <footer class="mm-footer">
        <p>Made by</p><a href="https://mattaningram.com">Mattan Ingram</a>
      </footer>
    </div>
  </main>
</Layout>

<style>
  .mm {
    overflow-x: hidden;
  }

  /* ── Hero ── */
  .mm-hero {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    padding: 10vh 2rem 2rem;
    max-width: 38rem;
    margin: 0 auto;

    @media (width >= 48rem) {
      padding-top: 12vh;
    }
  }

  .mm-hero__icon {
    width: 100px;
    height: 100px;
    margin-bottom: 1.5rem;
    filter: drop-shadow(0 6px 30px color-mix(in oklch, var(--color-amber-500) 35%, transparent));

    img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    @media (width >= 40rem) {
      width: 120px;
      height: 120px;
    }
  }

  .mm-hero__title {
    font-size: clamp(2.5rem, 7vw, 4rem);
    font-weight: 700;
    line-height: 1;
    color: var(--color-stone-50);
    margin-bottom: 1rem;
    letter-spacing: -0.02em;
  }

  .mm-hero__sub {
    font-size: clamp(1.1rem, 2.5vw, 1.3rem);
    line-height: 1.55;
    color: var(--color-stone-400);
  }

  /* ── Problem ── */
  .mm-problem {
    max-width: 36rem;
    margin: 0 auto;
    padding: 4rem 2rem 6rem;

    @media (width >= 48rem) {
      padding: 6rem 2rem 8rem;
    }
  }

  .mm-problem__text {
    font-size: clamp(1.05rem, 2.2vw, 1.2rem);
    line-height: 1.7;
    color: var(--color-stone-300);

    & + & {
      margin-top: 1.5rem;
    }
  }

  /* ── Scrollytelling ── */
  .mm-scroll {
    padding: 2rem 0;
  }

  .mm-scroll__inner {
    max-width: 72rem;
    margin: 0 auto;
    padding: 0 2rem;
    position: relative;

    /* Mobile: stacked */
    display: flex;
    flex-direction: column;
    align-items: center;

    @media (width >= 48rem) {
      /* Desktop: side by side */
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4rem;
      align-items: start;
    }
  }

  /* Text column */
  .mm-scroll__text-col {
    @media (width >= 48rem) {
      grid-column: 1;
    }
  }

  .mm-scroll__step {
    min-height: 70vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding: 2rem 0;
    opacity: 0.3;
    transition: opacity 0.5s ease;

    @media (width < 48rem) {
      min-height: 50vh;
      text-align: center;
    }
  }

  .mm-scroll__step-title {
    font-size: clamp(1.2rem, 2.5vw, 1.5rem);
    font-weight: 700;
    color: var(--color-amber-400);
    margin-bottom: 0.75rem;
  }

  .mm-scroll__step-text {
    font-size: clamp(1rem, 2vw, 1.15rem);
    line-height: 1.65;
    color: var(--color-stone-300);
    max-width: 28rem;

    @media (width < 48rem) {
      margin: 0 auto;
    }
  }

  /* Phone column */
  .mm-scroll__phone-col {
    @media (width < 48rem) {
      order: -1;
      width: 100%;
      display: flex;
      justify-content: center;
    }

    @media (width >= 48rem) {
      grid-column: 2;
    }
  }

  .mm-scroll__phone-sticky {
    position: sticky;
    top: 50%;
    transform: translateY(-50%);
    will-change: opacity, transform;

    @media (width < 48rem) {
      position: sticky;
      top: 2rem;
      transform: scale(0.85);
      transform-origin: top center;
      z-index: 10;
    }
  }

  /* Phone layers: stacked for crossfade */
  .mm-scroll__phone-layer {
    transition: opacity 0.6s cubic-bezier(0.25, 1, 0.5, 1);
  }

  .mm-scroll__phone-layer[data-layer="views"] {
    position: absolute;
    inset: 0;
    opacity: 0;
    pointer-events: none;
  }

  /* ── Features ── */
  .mm-features {
    max-width: 36rem;
    margin: 0 auto;
    padding: 6rem 2rem 8rem;
  }

  .mm-features__text {
    font-size: clamp(1.05rem, 2.2vw, 1.2rem);
    line-height: 1.7;
    color: var(--color-stone-400);
  }

  /* ── CTA Button ── */
  @property --gradient-angle {
    syntax: '<angle>';
    initial-value: 135deg;
    inherits: true;
  }

  .mm-cta-btn {
    --button-height: 56px;
    --button-radius: calc(var(--button-height) / 2);
    --border-size: 2px;
    --gradient-angle: 0deg;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    height: var(--button-height);
    border-radius: var(--button-radius);
    padding: 14px 28px;
    cursor: pointer;
    background: conic-gradient(
      from var(--gradient-angle),
      var(--color-amber-700) 0deg,
      var(--color-amber-600) 140deg,
      var(--color-amber-500) 180deg,
      var(--color-amber-600) 220deg,
      var(--color-amber-700) 360deg
    );

    transition: transform 0.15s cubic-bezier(0.25, 1, 0.5, 1);

    &:active {
      transform: scale(1.05);
    }

    &::before {
      content: '';
      position: absolute;
      inset: calc(-1 * var(--border-size));
      border-radius: calc(var(--button-radius) + var(--border-size));
      background: conic-gradient(
        from var(--gradient-angle),
        color-mix(in oklch, var(--color-amber-200) 20%, transparent) 0deg,
        color-mix(in oklch, var(--color-amber-400) 60%, transparent) 160deg,
        var(--color-amber-100) 180deg,
        color-mix(in oklch, var(--color-amber-400) 60%, transparent) 200deg,
        color-mix(in oklch, var(--color-amber-200) 20%, transparent) 360deg
      );
      z-index: -1;
      pointer-events: none;
    }
  }

  .mm-cta-btn__label {
    font-family: 'Nunito Sans', system-ui, sans-serif;
    font-weight: 600;
    font-size: 1.05rem;
    color: #fff;
  }

  .mm-requirements__wrap {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
  }

  .mm-requirements {
    font-size: 0.875rem;
    color: var(--color-stone-500);
    line-height: 1.4;
  }

  /* ── Bottom gradient wrapper ── */
  .mm-bottom-gradient {
    position: relative;
    background-image: radial-gradient(
      160vw 100% at bottom center,
      color-mix(in oklch, var(--color-amber-500) 75%, transparent) 0%,
      color-mix(in oklch, var(--color-amber-500) 25%, transparent) 25%,
      color-mix(in oklch, var(--color-amber-500) 0%, transparent) 100%
    );

    .mm-requirements {
      color: var(--color-amber-100);
    }
  }

  /* ── Bottom CTA ── */
  .mm-bottom-cta {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    padding: 8rem 2rem;
    position: relative;
  }

  .mm-bottom-cta__icon {
    width: 80px;
    height: 80px;
    margin-bottom: 1.25rem;
    will-change: transform;
    filter: drop-shadow(0 6px 30px color-mix(in oklch, var(--color-amber-500) 35%, transparent));
    transition:
      transform 0.3s cubic-bezier(0.25, 1, 0.5, 1),
      filter 0.3s cubic-bezier(0.25, 1, 0.5, 1);

    img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    @media (width >= 40rem) {
      width: 100px;
      height: 100px;
    }
  }

  .mm-bottom-cta:has(.mm-cta-btn:hover) .mm-bottom-cta__icon {
    transform: scale(1.1);
    filter: drop-shadow(0 10px 45px color-mix(in oklch, var(--color-amber-500) 60%, transparent));
  }

  .mm-bottom-cta__desc {
    font-size: 0.9rem;
    color: var(--color-amber-400);
    margin-bottom: 1.75rem;
  }

  /* ── Footer ── */
  .mm-footer {
    display: grid;
    text-align: center;
    padding: 2rem;
    color: rgba(white, 0.75);

    p {
      font-size: 0.75rem;
    }

    a {
      color: var(--color-amber-50);
      text-decoration: none;
      font-weight: 500;

      &:hover {
        color: var(--color-stone-50);
      }
    }

    @media (width >= 40rem) {
      text-align: left;
      position: absolute;
      bottom: 0;
      left: 0;
    }
  }
</style>

<!-- CTA button gradient angle animation -->
<script>
  const buttons = document.querySelectorAll('.mm-cta-btn')
  const angles = new Map<Element, number>()

  document.addEventListener('pointermove', (e) => {
    buttons.forEach((btn) => {
      const rect = btn.getBoundingClientRect()
      const cx = rect.left + rect.width / 2
      const cy = rect.top + rect.height / 2
      const target = Math.atan2(e.clientY - cy, e.clientX - cx) * (180 / Math.PI) - 90

      let current = angles.get(btn) ?? target
      let diff = target - current
      diff = (((diff % 360) + 540) % 360) - 180
      current += diff
      angles.set(btn, current)
      ;(btn as HTMLElement).style.setProperty('--gradient-angle', `${current}deg`)
    })
  })
</script>

<!-- Scroll controller -->
<script>
  import { animate, scroll } from 'motion'

  function initScrollytelling() {
    const steps = document.querySelectorAll('.mm-scroll__step') as NodeListOf<HTMLElement>
    const demoLayer = document.querySelector('[data-layer="demo"]') as HTMLElement
    const viewsLayer = document.querySelector('[data-layer="views"]') as HTMLElement
    const demoEl = document.querySelector('.mm-demo') as HTMLElement
    const viewsEl = document.querySelector('.mmv') as HTMLElement
    const phoneSticky = document.querySelector('.mm-scroll__phone-sticky') as HTMLElement

    if (!steps.length || !demoLayer || !viewsLayer || !demoEl || !viewsEl || !phoneSticky) return

    let currentStep: string | null = null
    let demoStarted = false

    // ── Phone entrance: fade/scale in on scroll ──
    scroll(
      animate(
        phoneSticky,
        { opacity: [0, 1], scale: [0.92, 1] },
        { easing: [0.25, 1, 0.5, 1] },
      ),
      {
        target: phoneSticky,
        offset: ['start end', 'start 60%'],
      },
    )

    // ── Step observer ──
    const observer = new IntersectionObserver(
      (entries) => {
        let bestEntry: IntersectionObserverEntry | null = null
        let bestRatio = 0

        for (const entry of entries) {
          if (entry.isIntersecting && entry.intersectionRatio > bestRatio) {
            bestRatio = entry.intersectionRatio
            bestEntry = entry
          }
        }

        if (!bestEntry || bestRatio < 0.2) return

        const stepName = (bestEntry.target as HTMLElement).dataset.step
        if (stepName === currentStep) return
        currentStep = stepName || null

        onStepChange(currentStep)
      },
      {
        root: null,
        rootMargin: '-30% 0px -30% 0px',
        threshold: [0, 0.25, 0.5, 0.75, 1.0],
      },
    )

    steps.forEach((step) => observer.observe(step))

    function onStepChange(step: string | null) {
      if (!step) return

      // Highlight active text step
      steps.forEach((s) => {
        s.style.opacity = s.dataset.step === step ? '1' : '0.3'
      })

      const isDemo = step === 'demo-intro' || step === 'demo-watch'
      const isViews = step.startsWith('view')

      if (isDemo) {
        showDemoLayer()
        if (!demoStarted) {
          demoStarted = true
          demoEl.dispatchEvent(new CustomEvent('demo:start'))
        }
      } else if (isViews) {
        showViewsLayer()
        if (demoStarted) {
          demoEl.dispatchEvent(new CustomEvent('demo:stop'))
          demoStarted = false
        }

        let viewName = 'timeline'
        if (step === 'view-timeline' || step === 'views-intro') viewName = 'timeline'
        else if (step === 'view-calendar') viewName = 'calendar'
        else if (step === 'view-map') viewName = 'map'

        viewsEl.dispatchEvent(new CustomEvent('views:show', { detail: { view: viewName } }))
      }
    }

    function showDemoLayer() {
      demoLayer.style.opacity = '1'
      demoLayer.style.pointerEvents = 'auto'
      viewsLayer.style.opacity = '0'
      viewsLayer.style.pointerEvents = 'none'
    }

    function showViewsLayer() {
      demoLayer.style.opacity = '0'
      demoLayer.style.pointerEvents = 'none'
      viewsLayer.style.opacity = '1'
      viewsLayer.style.pointerEvents = 'auto'
    }
  }

  document.addEventListener('astro:page-load', initScrollytelling)
</script>
