---
import PhoneFrame from '@components/PhoneFrame.astro'
---

<!-- Demo Animation Section -->
<section class="mm-demo flex flex-col items-center pt-16 px-8 pb-24" aria-label="How MetMe works">
  <PhoneFrame>
    <div class="mm-demo__prompt-container px-[22px] sm:px-[26px]">
      <!-- Step 1: Prompt -->
      <p class="mm-demo__prompt text-[1.15rem] font-semibold text-amber-500 opacity-0 self-start sm:text-[1.3rem]">Who did you meet?</p>

      <!-- Step 2: Text appears -->
      <div class="mm-demo__text hidden text-[1.1rem] font-semibold text-amber-400 leading-[1.5] self-start relative sm:text-[1.2rem]">
        <span class="mm-demo__word inline opacity-0">I</span>{' '}
        <span class="mm-demo__word inline opacity-0">met</span>{' '}
        <span class="mm-demo__word inline opacity-0" data-field="name">Michele Mouton</span>{' '}
        <span class="mm-demo__word inline opacity-0">a</span>{' '}
        <span class="mm-demo__word inline opacity-0" data-field="title">driver</span>{' '}
        <span class="mm-demo__word inline opacity-0">at</span>{' '}
        <span class="mm-demo__word inline opacity-0" data-field="company">Group B Rally</span>{' '}
        <span class="mm-demo__word inline opacity-0" data-field="phone">415-555-9876</span>{' '}
        <span class="mm-demo__word inline opacity-0" data-field="email">michele@mouton.com</span>
      </div>
    </div>

    <!-- Step 3: Parsed contact card -->
    <div class="mm-demo__contact hidden w-full mt-auto mb-[104px]">
      <div class="mm-demo__contact-row flex justify-start items-baseline gap-3 py-2 px-6 opacity-0">
        <span class="mm-demo__contact-label text-[0.65rem] w-[60px] text-stone-500 uppercase tracking-[0.04em] sm:w-[70px] sm:text-[0.7rem]">Name</span>
        <span class="mm-demo__contact-value text-[0.85rem] font-medium text-stone-100 sm:text-[0.9rem]">Michele Mouton</span>
      </div>
      <div class="mm-demo__contact-row flex justify-start items-baseline gap-3 py-2 px-6 opacity-0">
        <span class="mm-demo__contact-label text-[0.65rem] w-[60px] text-stone-500 uppercase tracking-[0.04em] sm:w-[70px] sm:text-[0.7rem]">Company</span>
        <span class="mm-demo__contact-value text-[0.85rem] font-medium text-stone-100 sm:text-[0.9rem]">Group B Rally</span>
      </div>
      <div class="mm-demo__contact-row flex justify-start items-baseline gap-3 py-2 px-6 opacity-0">
        <span class="mm-demo__contact-label text-[0.65rem] w-[60px] text-stone-500 uppercase tracking-[0.04em] sm:w-[70px] sm:text-[0.7rem]">Title</span>
        <span class="mm-demo__contact-value text-[0.85rem] font-medium text-stone-100 sm:text-[0.9rem]">Driver</span>
      </div>
      <div class="mm-demo__contact-row flex justify-start items-baseline gap-3 py-2 px-6 opacity-0">
        <span class="mm-demo__contact-label text-[0.65rem] w-[60px] text-stone-500 uppercase tracking-[0.04em] sm:w-[70px] sm:text-[0.7rem]">Phone</span>
        <span class="mm-demo__contact-value text-[0.85rem] font-medium text-stone-100 sm:text-[0.9rem]">415-555-9876</span>
      </div>
      <div class="mm-demo__contact-row flex justify-start items-baseline gap-3 py-2 px-6 opacity-0">
        <span class="mm-demo__contact-label text-[0.65rem] w-[60px] text-stone-500 uppercase tracking-[0.04em] sm:w-[70px] sm:text-[0.7rem]">Email</span>
        <span class="mm-demo__contact-value text-[0.85rem] font-medium text-stone-100 sm:text-[0.9rem]">michele@mouton.com</span>
      </div>
    </div>

    <!-- Delete button -->
    <div class="mm-demo__delete absolute rounded-full grid place-content-center opacity-0 sm:bottom-8 sm:w-[44px] sm:h-[44px]">
      <svg class="w-[18px] h-[18px]" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path
          d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m3 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6h14"
          stroke="currentColor"
          stroke-width="1.5"
          stroke-linecap="round"
          stroke-linejoin="round"></path>
      </svg>
    </div>

    <!-- Save button -->
    <div class="mm-demo__save absolute rounded-full grid place-content-center opacity-0 sm:bottom-8 sm:w-[44px] sm:h-[44px]">
      <svg class="w-[18px] h-[18px]" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path
          d="M20 6L9 17l-5-5"
          stroke="currentColor"
          stroke-width="2.5"
          stroke-linecap="round"
          stroke-linejoin="round"></path>
      </svg>
    </div>

    <!-- Context pill and mic button container -->
    <div class="mm-demo__input-container grid gap-3 justify-items-center absolute left-1/2 bottom-6 -translate-x-1/2 sm:bottom-7">
      <!-- Context pill -->
      <div class="mm-demo__context-pill flex gap-0 bg-stone-800 border border-stone-600 rounded-[20px] whitespace-nowrap">
        <span class="mm-demo__context-item flex items-center gap-[6px] text-[11px] font-medium text-stone-400 tracking-[0.01em] py-[3px] px-[7px] sm:text-[12px] sm:py-1 sm:px-2">
          <svg class="w-3 h-3 shrink-0 sm:w-[14px] sm:h-[14px]" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"
            ><rect x="1" y="3" width="14" height="12" rx="1.5" stroke="currentColor" stroke-width="1.2"></rect><path
              d="M1 6.5h14M5 1v4M11 1v4"
              stroke="currentColor"
              stroke-width="1.2"
              stroke-linecap="round"></path></svg
          >
          Today
        </span>
        <span class="mm-demo__context-divider w-[0.5px] border-dashed border border-stone-700"></span>
        <span class="mm-demo__context-item flex items-center gap-[6px] text-[11px] font-medium text-stone-400 tracking-[0.01em] py-[3px] px-[7px] sm:text-[12px] sm:py-1 sm:px-2">
          <svg class="w-3 h-3 shrink-0 sm:w-[14px] sm:h-[14px]" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"
            ><path d="M13 6.5c0 4.5-5 8-5 8s-5-3.5-5-8a5 5 0 0 1 10 0z" stroke="currentColor" stroke-width="1.2"
            ></path><circle cx="8" cy="6.5" r="1.5" stroke="currentColor" stroke-width="1.2"></circle></svg
          >
          Here
        </span>
      </div>

      <!-- Mic button -->
      <div class="mm-demo__mic w-12 h-12 bg-stone-800 border border-stone-600 rounded-full grid place-content-center text-stone-300 sm:w-14 sm:h-14">
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" fill="currentColor"></path>
          <path
            d="M19 10v2a7 7 0 0 1-14 0v-2M12 19v4m-4 0h8"
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"></path>
        </svg>
      </div>
    </div>

    <!-- Saved confirmation popup -->
    <div class="mm-demo__saved absolute bottom-0 left-0 right-0 flex flex-col items-center opacity-0 sm:rounded-b-[39px] sm:py-9 sm:px-7">
      <div class="mm-demo__saved-icon w-9 h-9 rounded-full grid place-content-center text-stone-50 mb-3">
        <svg class="w-[18px] h-[18px]" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path
            d="M20 6L9 17l-5-5"
            stroke="currentColor"
            stroke-width="2.5"
            stroke-linecap="round"
            stroke-linejoin="round"></path>
        </svg>
      </div>
      <p class="mm-demo__saved-name text-[0.95rem] font-semibold text-stone-50 mb-1">Michele Mouton saved</p>
      <p class="mm-demo__saved-detail text-[0.78rem] leading-[1.4]">Driver at Group B Rally</p>
      <p class="mm-demo__saved-detail text-[0.78rem] leading-[1.4]">415-555-9876</p>
      <span class="mm-demo__saved-view mt-[14px] text-[0.78rem] font-medium text-stone-50 rounded-2xl py-[5px] px-4">View contact</span>
    </div>
  </PhoneFrame>
</section>

<script>
  import { animate, stagger, inView } from 'motion'

  let abortController: AbortController | null = null

  function delay(ms: number, signal: AbortSignal): Promise<void> {
    return new Promise((resolve, reject) => {
      const id = setTimeout(resolve, ms)
      signal.addEventListener('abort', () => {
        clearTimeout(id)
        reject(new DOMException('Aborted', 'AbortError'))
      })
    })
  }

  function initDemoAnimation() {
    const demoSection = document.querySelector('.mm-demo')
    if (demoSection) {
      inView(
        demoSection,
        () => {
          startAnimation()
        },
        { amount: 0.3 },
      )
    }
  }

  function startAnimation() {
    if (abortController) abortController.abort()
    abortController = new AbortController()
    runDemoAnimation(abortController.signal)
  }

  async function runDemoAnimation(signal: AbortSignal) {
    const phone = document.querySelector('.mm-demo .phone-frame__phone') as HTMLElement
    const prompt = document.querySelector('.mm-demo__prompt') as HTMLElement
    const mic = document.querySelector('.mm-demo__mic') as HTMLElement
    const contextPill = document.querySelector('.mm-demo__context-pill') as HTMLElement
    const textWrap = document.querySelector('.mm-demo__text') as HTMLElement
    const words = document.querySelectorAll('.mm-demo__word')
    const contact = document.querySelector('.mm-demo__contact') as HTMLElement
    const contactRows = document.querySelectorAll('.mm-demo__contact-row')
    const deleteBtn = document.querySelector('.mm-demo__delete') as HTMLElement
    const saveBtn = document.querySelector('.mm-demo__save') as HTMLElement
    const saved = document.querySelector('.mm-demo__saved') as HTMLElement

    if (!phone || !prompt || !mic || !contextPill || !textWrap || !contact || !deleteBtn || !saveBtn || !saved) return

    try {
      // Prompt fades in
      prompt.style.display = ''
      await animate(prompt, { opacity: [0, 1] }, { duration: 0.5 }).finished
      if (signal.aborted) return

      // Mic pulses
      mic.classList.add('mm-demo__mic--active')

      await delay(800, signal)

      // Prompt fades out, text appears
      await animate(prompt, { opacity: 0 }, { duration: 0.3 }).finished
      prompt.style.display = 'none'
      if (signal.aborted) return

      // Reset text wrap and words to initial state before animating in
      textWrap.style.display = 'block'
      textWrap.style.opacity = '1'
      textWrap.style.transform = 'none'
      words.forEach((w) => {
        const el = w as HTMLElement
        el.style.opacity = '0'
        el.style.transform = 'none'
      })

      await animate(
        words,
        { opacity: [0, 1], y: [8, 0] } as any,
        { duration: 0.35, delay: stagger(0.12), easing: [0.25, 1, 0.5, 1] } as any,
      ).finished
      if (signal.aborted) return

      await delay(500, signal)

      // Mic stops pulsing
      mic.classList.remove('mm-demo__mic--active')

      // Amber gradient scan across the text
      textWrap.classList.add('mm-demo__text--scanning')
      await delay(2400, signal)
      textWrap.classList.remove('mm-demo__text--scanning')

      // Highlight parsed fields
      words.forEach((w) => {
        if ((w as HTMLElement).dataset.field) {
          ;(w as HTMLElement).classList.add('mm-demo__word--highlighted')
        }
      })
      await delay(500, signal)

      // Contact card slides up
      contact.style.display = 'block'
      contact.style.opacity = '0'
      contact.style.transform = 'none'
      contactRows.forEach((r) => {
        const el = r as HTMLElement
        el.style.opacity = '0'
        el.style.transform = 'none'
      })

      await animate(
        contact,
        { opacity: [0, 1], y: [20, 0] } as any,
        { duration: 0.5, easing: [0.25, 1, 0.5, 1] } as any,
      ).finished
      if (signal.aborted) return

      await animate(
        contactRows,
        { opacity: [0, 1], x: [-10, 0] } as any,
        { duration: 0.35, delay: stagger(0.08), easing: [0.25, 1, 0.5, 1] } as any,
      ).finished
      if (signal.aborted) return

      // Delete and save buttons animate in
      deleteBtn.style.opacity = '0'
      deleteBtn.style.transform = 'none'
      saveBtn.style.opacity = '0'
      saveBtn.style.transform = 'none'

      animate(
        deleteBtn,
        { opacity: [0, 1], scale: [0.8, 1] } as any,
        { duration: 0.35, easing: [0.25, 1, 0.5, 1] } as any,
      )
      await animate(
        saveBtn,
        { opacity: [0, 1], scale: [0.8, 1] } as any,
        { duration: 0.35, delay: 0.08, easing: [0.25, 1, 0.5, 1] } as any,
      ).finished
      if (signal.aborted) return

      // Hold the completed state
      await delay(1800, signal)

      // Save button "tapped"
      await animate(
        saveBtn,
        { scale: [1, 0.85], backgroundColor: ['oklch(35% 0.1 75)', 'oklch(65% 0.18 75)'] } as any,
        { duration: 0.1, easing: 'ease-in' } as any,
      ).finished
      await animate(
        saveBtn,
        { scale: [0.85, 1], backgroundColor: ['oklch(65% 0.18 75)', 'oklch(35% 0.1 75)'] } as any,
        { duration: 0.2, easing: [0.25, 1, 0.5, 1] } as any,
      ).finished
      if (signal.aborted) return

      await delay(200, signal)

      // Ensure elements are visible before exit animations
      textWrap.style.opacity = '1'
      contact.style.opacity = '1'

      // Contact card slides down and out, text animates out upward
      const contactOut = animate(
        contact,
        { opacity: [1, 0], y: [0, '100%'] } as any,
        { duration: 0.4, easing: [0.5, 0, 0.75, 0] } as any,
      )
      const textOut = animate(
        textWrap,
        { opacity: [1, 0], y: [0, '-100%'] } as any,
        { duration: 0.4, easing: [0.5, 0, 0.75, 0] } as any,
      )
      // Fade out delete and save buttons
      const deleteOut = animate(deleteBtn, { opacity: [1, 0] } as any, { duration: 0.3 })
      const saveOut = animate(saveBtn, { opacity: [1, 0] } as any, { duration: 0.3 })

      // Wait for all exit animations to complete
      await Promise.all([contactOut.finished, textOut.finished, deleteOut.finished, saveOut.finished])
      if (signal.aborted) return

      // Saved popup slides up from bottom
      saved.style.opacity = '0'
      saved.style.transform = 'none'

      await animate(saved, { opacity: [0, 1], y: [40, 0] } as any, { duration: 0.5, easing: [0.25, 1, 0.5, 1] } as any)
        .finished
      if (signal.aborted) return

      // Hold saved state
      await delay(2200, signal)

      // Fade out saved popup
      await animate(saved, { opacity: 0 }, { duration: 0.4 }).finished
      if (signal.aborted) return

      // Reset all state for next loop - clear all inline styles completely
      contact.style.cssText = 'display: none;'
      textWrap.style.cssText = 'display: none;'
      textWrap.classList.remove('mm-demo__text--scanning')
      deleteBtn.style.cssText = ''
      saveBtn.style.cssText = ''
      saved.style.cssText = ''

      words.forEach((w) => {
        const el = w as HTMLElement
        el.style.cssText = ''
        el.classList.remove('mm-demo__word--highlighted')
      })
      contactRows.forEach((r) => {
        ;(r as HTMLElement).style.cssText = ''
      })

      await delay(600, signal)

      // Loop
      runDemoAnimation(signal)
    } catch (e) {
      if (e instanceof DOMException && e.name === 'AbortError') return
      throw e
    }
  }

  // Run on load and on Astro page transitions
  document.addEventListener('astro:page-load', initDemoAnimation)
</script>

<style>
  .mm-demo :global(.phone-frame__screen) {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 56px 0 22px;

    @media (width >= 40rem) {
      padding: 64px 0 26px;
    }
  }

  .mm-demo__word {
    transition:
      color 0.4s ease,
      text-shadow 0.4s ease;
  }

  .mm-demo__word--highlighted {
    color: var(--color-amber-100);
    text-shadow: 0 0 12px color-mix(in oklch, var(--color-amber-500) 50%, transparent);
  }

  /* Scanning amber gradient sweep â€“ masked to text */
  .mm-demo__text--scanning {
    background: linear-gradient(
      135deg,
      var(--color-amber-400) 0%,
      var(--color-amber-400) 30%,
      var(--color-amber-100) 50%,
      var(--color-amber-400) 70%,
      var(--color-amber-400) 100%
    );
    background-size: 300% 100%;
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: text-scan 1.2s ease-in-out forwards infinite;
  }

  @keyframes text-scan {
    0% {
      background-position: 100% 0;
    }
    100% {
      background-position: 0% 0;
    }
  }

  .mm-demo__contact-row {
    border-bottom: 1px dashed color-mix(in oklch, var(--color-stone-800) 50%, transparent);
  }

  .mm-demo__delete,
  .mm-demo__save {
    bottom: 28px;
    width: 40px;
    height: 40px;
  }

  .mm-demo__delete {
    left: 20px;
    background: oklch(25% 0.05 25);
    border: 1px solid oklch(35% 0.08 25);
    color: oklch(60% 0.15 25);

    @media (width >= 40rem) {
      left: 24px;
    }
  }

  .mm-demo__save {
    right: 20px;
    background: color-mix(in oklch, var(--color-amber-500) 10%, transparent);
    border: 1px solid var(--color-amber-500);
    color: var(--color-stone-50);

    @media (width >= 40rem) {
      right: 24px;
    }
  }

  .mm-demo__saved {
    padding: 32px 24px 28px;
    background: linear-gradient(180deg, oklch(20% 0.04 160 / 0) 0%, oklch(25% 0.06 160) 30%, oklch(28% 0.07 155) 100%);
    border-radius: 0 0 34px 34px;
  }

  .mm-demo__saved-icon {
    background: oklch(55% 0.12 160);
  }

  .mm-demo__saved-detail {
    color: oklch(70% 0.03 160);
  }

  .mm-demo__saved-view {
    border: 1px solid oklch(70% 0.05 160 / 0.4);
  }

  .mm-demo__mic--active {
    animation: mic-pulse 1s ease-in-out infinite;
    color: var(--color-amber-400);
    border-color: var(--color-amber-500);
    background: var(--color-amber-950);
  }

  @keyframes mic-pulse {
    0%,
    100% {
      box-shadow: 0 0 0 0 color-mix(in oklch, var(--color-amber-500) 30%, transparent);
    }
    50% {
      box-shadow: 0 0 0 10px color-mix(in oklch, var(--color-amber-500) 0%, transparent);
    }
  }
</style>
