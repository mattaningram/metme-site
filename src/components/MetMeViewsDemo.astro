---
import PhoneFrame from '@components/PhoneFrame.astro'

function formatRelativeDate(daysAgo: number): string {
  if (daysAgo === 0) return 'TODAY'
  if (daysAgo === 1) return 'YESTERDAY'
  const date = new Date()
  date.setDate(date.getDate() - daysAgo)
  const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT']
  const months = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC']
  return `${days[date.getDay()]}, ${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`
}

const timelineGroups = [
  { label: formatRelativeDate(0), contacts: ['Michele Mouton', 'Sarah Chen'] },
  { label: formatRelativeDate(1), contacts: ['Priya Sharma', 'Marcus Rivera'] },
  { label: formatRelativeDate(3), contacts: ['Tina Park', 'Layla Okonkwo'] },
  { label: formatRelativeDate(5), contacts: ['James Nakamura'] },
  { label: formatRelativeDate(7), contacts: ['Carlos Mendez', 'Amara Diallo'] },
  { label: formatRelativeDate(10), contacts: ['David Kim'] },
  { label: formatRelativeDate(13), contacts: ['Sofia Petrov', 'Omar Hassan'] },
  { label: formatRelativeDate(16), contacts: ['Kenji Watanabe', 'Elena Vasquez'] },
]
---

<!-- Views Demo Animation Section -->
<section class="mmv pt-16 px-8 pb-24 max-w-[62rem] mx-auto" aria-label="Three ways to remember">
  <div class="mmv__content flex flex-col items-center gap-10">
    <!-- Left: text + feature cards -->
    <div class="mmv__text">
      <h2 class="mmv__heading text-[clamp(1.4rem,3vw,1.75rem)] font-bold text-stone-50 mb-3">Three ways to remember</h2>
      <p class="mmv__sub text-[0.95rem] text-stone-400 leading-[1.55] mb-6">Every contact saves when and where you met. Browse your network across time and space.</p>
    </div>

    <!-- Right: phone demo -->
    <PhoneFrame>
      <!-- ===== TIMELINE VIEW ===== -->
      <div class="mmv__gate absolute inset-0" data-gate="timeline" style="display:none">
        <div class="mmv__view mmv__view--timeline absolute inset-0 overflow-hidden pt-12 grid" data-view="timeline">
          <div class="mmv__tl-scroll-wrap overflow-y-auto [scrollbar-width:none]">
            <div class="mmv__tl-scroll pb-12">
              {
                timelineGroups.map((group) => (
                  <>
                    <div class="mmv__tl-header text-[0.55rem] font-semibold uppercase tracking-[0.06em] text-stone-500 py-2 px-4 opacity-0 sticky top-0 z-[2] sm:text-[0.6rem]">{group.label}</div>
                    {group.contacts.map((name) => (
                      <div class="mmv__tl-row flex items-center gap-[10px] py-2 px-4 opacity-0">
                        <span class="mmv__tl-avatar w-[30px] h-[30px] rounded-full text-amber-400 grid place-content-center text-[0.65rem] font-bold shrink-0 sm:w-[34px] sm:h-[34px] sm:text-[0.7rem]">{name[0]}</span>
                        <span class="mmv__tl-name text-[0.78rem] font-medium text-stone-200 sm:text-[0.85rem]">{name}</span>
                      </div>
                    ))}
                  </>
                ))
              }
            </div>
          </div>
        </div>
      </div>

      <!-- ===== CALENDAR VIEW ===== -->
      <div class="mmv__gate absolute inset-0" data-gate="calendar" style="display:none">
        <div class="mmv__view mmv__view--calendar absolute inset-0 overflow-hidden pt-12 grid" data-view="calendar">
          <div class="mmv__cal-scroll-wrap overflow-y-auto [scrollbar-width:none]">
            <div class="mmv__cal-scroll pb-12">
              <!-- February 2026 -->
              <div class="mmv__cal-month mb-2">
                <p class="mmv__cal-month-label sticky top-0 z-[2] text-[0.72rem] font-bold text-stone-300 pt-[10px] px-3 pb-[6px]">February 2026</p>
                <div class="mmv__cal-weekdays grid grid-cols-7 text-center mb-[2px]">
                  <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span
                    >Sat</span
                  >
                </div>
                <div class="mmv__cal-grid grid grid-cols-7 text-center">
                  <!-- Feb 2026: starts on Sunday -->
                  <span class="mmv__cal-day">1</span>
                  <span class="mmv__cal-day">2</span>
                  <span class="mmv__cal-day mmv__cal-day--event">3</span>
                  <span class="mmv__cal-day">4</span>
                  <span class="mmv__cal-day">5</span>
                  <span class="mmv__cal-day">6</span>
                  <span class="mmv__cal-day">7</span>
                  <span class="mmv__cal-day">8</span>
                  <span class="mmv__cal-day">9</span>
                  <span class="mmv__cal-day">10</span>
                  <span class="mmv__cal-day">11</span>
                  <span class="mmv__cal-day">12</span>
                  <span class="mmv__cal-day">13</span>
                  <span class="mmv__cal-day mmv__cal-day--event">14</span>
                  <span class="mmv__cal-day">15</span>
                  <span class="mmv__cal-day mmv__cal-day--event">16</span>
                  <span class="mmv__cal-day mmv__cal-day--event">17</span>
                  <span class="mmv__cal-day mmv__cal-day--event">18</span>
                  <span class="mmv__cal-day">19</span>
                  <span class="mmv__cal-day">20</span>
                  <span class="mmv__cal-day">21</span>
                  <span class="mmv__cal-day">22</span>
                  <span class="mmv__cal-day">23</span>
                  <span class="mmv__cal-day">24</span>
                  <span class="mmv__cal-day">25</span>
                  <span class="mmv__cal-day">26</span>
                  <span class="mmv__cal-day">27</span>
                  <span class="mmv__cal-day">28</span>
                </div>
              </div>
              <!-- March 2026 -->
              <div class="mmv__cal-month mb-2">
                <p class="mmv__cal-month-label sticky top-0 z-[2] text-[0.72rem] font-bold text-stone-300 pt-[10px] px-3 pb-[6px]">March 2026</p>
                <div class="mmv__cal-weekdays grid grid-cols-7 text-center mb-[2px]">
                  <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span
                    >Sat</span
                  >
                </div>
                <div class="mmv__cal-grid grid grid-cols-7 text-center">
                  <!-- March 2026: starts on Sunday -->
                  <span class="mmv__cal-day">1</span>
                  <span class="mmv__cal-day mmv__cal-day--event">2</span>
                  <span class="mmv__cal-day">3</span>
                  <span class="mmv__cal-day">4</span>
                  <span class="mmv__cal-day mmv__cal-day--event">5</span>
                  <span class="mmv__cal-day">6</span>
                  <span class="mmv__cal-day">7</span>
                  <span class="mmv__cal-day">8</span>
                  <span class="mmv__cal-day">9</span>
                  <span class="mmv__cal-day">10</span>
                  <span class="mmv__cal-day">11</span>
                  <span class="mmv__cal-day">12</span>
                  <span class="mmv__cal-day">13</span>
                  <span class="mmv__cal-day mmv__cal-day--event">14</span>
                  <span class="mmv__cal-day">15</span>
                  <span class="mmv__cal-day mmv__cal-day--event" data-select="true">16</span>
                  <span class="mmv__cal-day">17</span>
                  <span class="mmv__cal-day">18</span>
                  <span class="mmv__cal-day">19</span>
                  <span class="mmv__cal-day">20</span>
                  <span class="mmv__cal-day">21</span>
                  <span class="mmv__cal-day">22</span>
                  <span class="mmv__cal-day">23</span>
                  <span class="mmv__cal-day">24</span>
                  <span class="mmv__cal-day">25</span>
                  <span class="mmv__cal-day">26</span>
                  <span class="mmv__cal-day">27</span>
                  <span class="mmv__cal-day">28</span>
                  <span class="mmv__cal-day">29</span>
                  <span class="mmv__cal-day">30</span>
                  <span class="mmv__cal-day">31</span>
                </div>
              </div>
              <!-- April 2026 -->
              <div class="mmv__cal-month mb-2">
                <p class="mmv__cal-month-label sticky top-0 z-[2] text-[0.72rem] font-bold text-stone-300 pt-[10px] px-3 pb-[6px]">April 2026</p>
                <div class="mmv__cal-weekdays grid grid-cols-7 text-center mb-[2px]">
                  <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span
                    >Sat</span
                  >
                </div>
                <div class="mmv__cal-grid grid grid-cols-7 text-center">
                  <!-- April 2026: starts on Wednesday -->
                  <span class="mmv__cal-day mmv__cal-day--empty"></span>
                  <span class="mmv__cal-day mmv__cal-day--empty"></span>
                  <span class="mmv__cal-day mmv__cal-day--empty"></span>
                  <span class="mmv__cal-day">1</span>
                  <span class="mmv__cal-day">2</span>
                  <span class="mmv__cal-day mmv__cal-day--event">3</span>
                  <span class="mmv__cal-day">4</span>
                  <span class="mmv__cal-day">5</span>
                  <span class="mmv__cal-day">6</span>
                  <span class="mmv__cal-day">7</span>
                  <span class="mmv__cal-day">8</span>
                  <span class="mmv__cal-day mmv__cal-day--event">9</span>
                  <span class="mmv__cal-day">10</span>
                  <span class="mmv__cal-day">11</span>
                  <span class="mmv__cal-day">12</span>
                  <span class="mmv__cal-day">13</span>
                  <span class="mmv__cal-day">14</span>
                  <span class="mmv__cal-day">15</span>
                  <span class="mmv__cal-day">16</span>
                  <span class="mmv__cal-day">17</span>
                  <span class="mmv__cal-day mmv__cal-day--event">18</span>
                  <span class="mmv__cal-day">19</span>
                  <span class="mmv__cal-day">20</span>
                  <span class="mmv__cal-day">21</span>
                  <span class="mmv__cal-day mmv__cal-day--event">22</span>
                  <span class="mmv__cal-day">23</span>
                  <span class="mmv__cal-day">24</span>
                  <span class="mmv__cal-day">25</span>
                  <span class="mmv__cal-day">26</span>
                  <span class="mmv__cal-day">27</span>
                  <span class="mmv__cal-day">28</span>
                  <span class="mmv__cal-day">29</span>
                  <span class="mmv__cal-day">30</span>
                </div>
              </div>
              <!-- May 2026 -->
              <div class="mmv__cal-month mb-2">
                <p class="mmv__cal-month-label sticky top-0 z-[2] text-[0.72rem] font-bold text-stone-300 pt-[10px] px-3 pb-[6px]">May 2026</p>
                <div class="mmv__cal-weekdays grid grid-cols-7 text-center mb-[2px]">
                  <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span
                    >Sat</span
                  >
                </div>
                <div class="mmv__cal-grid grid grid-cols-7 text-center">
                  <!-- May 2026: starts on Friday -->
                  <span class="mmv__cal-day mmv__cal-day--empty"></span>
                  <span class="mmv__cal-day mmv__cal-day--empty"></span>
                  <span class="mmv__cal-day mmv__cal-day--empty"></span>
                  <span class="mmv__cal-day mmv__cal-day--empty"></span>
                  <span class="mmv__cal-day mmv__cal-day--empty"></span>
                  <span class="mmv__cal-day">1</span>
                  <span class="mmv__cal-day">2</span>
                  <span class="mmv__cal-day">3</span>
                  <span class="mmv__cal-day mmv__cal-day--event">4</span>
                  <span class="mmv__cal-day">5</span>
                  <span class="mmv__cal-day">6</span>
                  <span class="mmv__cal-day">7</span>
                  <span class="mmv__cal-day">8</span>
                  <span class="mmv__cal-day">9</span>
                  <span class="mmv__cal-day">10</span>
                  <span class="mmv__cal-day">11</span>
                  <span class="mmv__cal-day">12</span>
                  <span class="mmv__cal-day mmv__cal-day--event">13</span>
                  <span class="mmv__cal-day">14</span>
                  <span class="mmv__cal-day">15</span>
                  <span class="mmv__cal-day">16</span>
                  <span class="mmv__cal-day">17</span>
                  <span class="mmv__cal-day">18</span>
                  <span class="mmv__cal-day">19</span>
                  <span class="mmv__cal-day mmv__cal-day--event">20</span>
                  <span class="mmv__cal-day">21</span>
                  <span class="mmv__cal-day">22</span>
                  <span class="mmv__cal-day">23</span>
                  <span class="mmv__cal-day">24</span>
                  <span class="mmv__cal-day">25</span>
                  <span class="mmv__cal-day">26</span>
                  <span class="mmv__cal-day">27</span>
                  <span class="mmv__cal-day">28</span>
                  <span class="mmv__cal-day mmv__cal-day--event">29</span>
                  <span class="mmv__cal-day">30</span>
                  <span class="mmv__cal-day">31</span>
                </div>
              </div>
            </div>
            <!-- Calendar popup -->
            <div class="mmv__popup mmv__popup--cal absolute bottom-0 left-0 right-0 opacity-0 z-[5] py-6 px-[18px] pb-16 sm:py-7 sm:px-[22px] sm:pb-[72px]">
              <p class="mmv__popup-date text-[0.72rem] font-bold text-stone-100 mb-[2px] sm:text-[0.78rem]">Monday, March 16, 2026</p>
              <p class="mmv__popup-count text-[0.6rem] text-stone-400 mb-[10px] sm:text-[0.65rem]">1 contact</p>
              <div class="mmv__popup-contact flex gap-[10px] items-start">
                <span class="mmv__tl-avatar w-[30px] h-[30px] rounded-full text-amber-400 grid place-content-center text-[0.65rem] font-bold shrink-0 sm:w-[34px] sm:h-[34px] sm:text-[0.7rem]">J</span>
                <div class="mmv__popup-info flex flex-col gap-[2px]">
                  <span class="mmv__popup-name text-[0.75rem] font-semibold text-stone-100 sm:text-[0.8rem]">Jane Smith</span>
                  <span class="mmv__popup-detail text-[0.6rem] text-stone-400 flex items-center gap-[5px] sm:text-[0.65rem]">
                    <span class="mmv__popup-dot mmv__popup-dot--met w-[5px] h-[5px] rounded-full shrink-0 bg-amber-500"></span>
                    Met contact date
                  </span>
                  <span class="mmv__popup-detail text-[0.6rem] text-stone-400 flex items-center gap-[5px] sm:text-[0.65rem]">
                    <span class="mmv__popup-dot mmv__popup-dot--bday w-[5px] h-[5px] rounded-full shrink-0"></span>
                    Birthday (turns 33)
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== MAP VIEW ===== -->
      <div class="mmv__gate absolute inset-0" data-gate="map" style="display:none">
        <div class="mmv__view mmv__view--map absolute inset-0 overflow-hidden" data-view="map">
          <div class="mmv__map-container absolute will-change-transform" style="inset: -70px">
            <svg
              class="mmv__map-svg w-full h-full"
              viewBox="0 0 800 550"
              preserveAspectRatio="xMidYMid slice"
              xmlns="http://www.w3.org/2000/svg"
            >
              <!-- Water -->
              <rect width="800" height="550" fill="oklch(18% 0.006 50)"></rect>
              <path d="M0 0 L100 0 L80 100 L90 220 L70 350 L85 550 L0 550Z" fill="oklch(22% 0.03 240)"></path>
              <path d="M580 550 L610 470 L700 440 L800 460 L800 550Z" fill="oklch(22% 0.03 240)"></path>
              <path d="M720 0 L800 0 L800 130 L740 110 L730 50Z" fill="oklch(22% 0.03 240)"></path>

              <!-- City blocks -->
              <g fill="oklch(22% 0.008 50)">
                <rect x="120" y="25" width="70" height="55" rx="2"></rect>
                <rect x="205" y="25" width="80" height="55" rx="2"></rect>
                <rect x="300" y="25" width="65" height="55" rx="2"></rect>
                <rect x="380" y="25" width="75" height="55" rx="2"></rect>
                <rect x="470" y="25" width="70" height="55" rx="2"></rect>
                <rect x="555" y="25" width="80" height="55" rx="2"></rect>
                <rect x="650" y="25" width="55" height="55" rx="2"></rect>

                <rect x="120" y="100" width="70" height="60" rx="2"></rect>
                <rect x="205" y="100" width="80" height="60" rx="2"></rect>
                <rect x="300" y="100" width="65" height="60" rx="2"></rect>
                <rect x="380" y="100" width="75" height="60" rx="2"></rect>
                <rect x="470" y="100" width="70" height="60" rx="2"></rect>
                <rect x="555" y="100" width="80" height="60" rx="2"></rect>
                <rect x="650" y="100" width="55" height="60" rx="2"></rect>

                <rect x="120" y="180" width="70" height="55" rx="2"></rect>
                <rect x="205" y="180" width="80" height="55" rx="2"></rect>
                <rect x="300" y="180" width="65" height="55" rx="2"></rect>
                <rect x="380" y="180" width="75" height="55" rx="2"></rect>
                <rect x="470" y="180" width="70" height="55" rx="2"></rect>
                <rect x="555" y="180" width="80" height="55" rx="2"></rect>
                <rect x="650" y="180" width="55" height="55" rx="2"></rect>

                <rect x="120" y="255" width="70" height="60" rx="2"></rect>
                <rect x="205" y="255" width="80" height="60" rx="2"></rect>
                <rect x="300" y="255" width="65" height="60" rx="2"></rect>
                <rect x="380" y="255" width="75" height="60" rx="2"></rect>
                <rect x="470" y="255" width="70" height="60" rx="2"></rect>
                <rect x="555" y="255" width="80" height="60" rx="2"></rect>

                <rect x="120" y="335" width="70" height="55" rx="2"></rect>
                <rect x="205" y="335" width="80" height="55" rx="2"></rect>
                <rect x="300" y="335" width="65" height="55" rx="2"></rect>
                <rect x="380" y="335" width="75" height="55" rx="2"></rect>
                <rect x="470" y="335" width="70" height="55" rx="2"></rect>

                <rect x="120" y="410" width="70" height="60" rx="2"></rect>
                <rect x="205" y="410" width="80" height="60" rx="2"></rect>
                <rect x="300" y="410" width="65" height="60" rx="2"></rect>
                <rect x="380" y="410" width="75" height="60" rx="2"></rect>

                <rect x="120" y="490" width="70" height="45" rx="2"></rect>
                <rect x="205" y="490" width="80" height="45" rx="2"></rect>
                <rect x="300" y="490" width="65" height="45" rx="2"></rect>
              </g>

              <!-- Major roads -->
              <g stroke="oklch(25% 0.008 50)" stroke-width="2" fill="none">
                <line x1="115" y1="0" x2="115" y2="550"></line>
                <line x1="195" y1="0" x2="195" y2="550"></line>
                <line x1="290" y1="0" x2="290" y2="550"></line>
                <line x1="370" y1="0" x2="370" y2="550"></line>
                <line x1="460" y1="0" x2="460" y2="550"></line>
                <line x1="545" y1="0" x2="545" y2="400"></line>
                <line x1="640" y1="0" x2="640" y2="325"></line>
                <line x1="710" y1="0" x2="710" y2="250"></line>
                <line x1="100" y1="92" x2="720" y2="92"></line>
                <line x1="100" y1="172" x2="720" y2="172"></line>
                <line x1="100" y1="248" x2="710" y2="248"></line>
                <line x1="100" y1="328" x2="640" y2="328"></line>
                <line x1="100" y1="403" x2="550" y2="403"></line>
                <line x1="100" y1="483" x2="460" y2="483"></line>
              </g>

              <!-- Diagonal avenue -->
              <line x1="110" y1="70" x2="630" y2="360" stroke="oklch(27% 0.008 50)" stroke-width="3"></line>
            </svg>

            <!-- Map markers -->
            <div class="mmv__map-marker absolute w-[18px] h-6 opacity-0 will-change-transform sm:w-5 sm:h-[26px]" style="top: 18%; left: 30%;" data-name="Michele Mouton">
              <svg class="w-full h-full" viewBox="0 0 24 32" fill="none" xmlns="http://www.w3.org/2000/svg"
                ><ellipse cx="12" cy="30" rx="5" ry="2" fill="oklch(0% 0 0 / 0.3)"></ellipse><path
                  d="M12 0C6.48 0 2 4.48 2 10c0 7.5 10 20 10 20s10-12.5 10-20c0-5.52-4.48-10-10-10z"
                  fill="oklch(58% 0.22 20)"></path><circle cx="12" cy="10" r="4" fill="oklch(75% 0.15 20)"
                ></circle></svg
              >
            </div>
            <div class="mmv__map-marker absolute w-[18px] h-6 opacity-0 will-change-transform sm:w-5 sm:h-[26px]" style="top: 32%; left: 55%;" data-name="Sarah Chen">
              <svg class="w-full h-full" viewBox="0 0 24 32" fill="none" xmlns="http://www.w3.org/2000/svg"
                ><ellipse cx="12" cy="30" rx="5" ry="2" fill="oklch(0% 0 0 / 0.3)"></ellipse><path
                  d="M12 0C6.48 0 2 4.48 2 10c0 7.5 10 20 10 20s10-12.5 10-20c0-5.52-4.48-10-10-10z"
                  fill="oklch(58% 0.22 20)"></path><circle cx="12" cy="10" r="4" fill="oklch(75% 0.15 20)"
                ></circle></svg
              >
            </div>
            <div class="mmv__map-marker absolute w-[18px] h-6 opacity-0 will-change-transform sm:w-5 sm:h-[26px]" style="top: 45%; left: 38%;" data-name="Priya Sharma">
              <svg class="w-full h-full" viewBox="0 0 24 32" fill="none" xmlns="http://www.w3.org/2000/svg"
                ><ellipse cx="12" cy="30" rx="5" ry="2" fill="oklch(0% 0 0 / 0.3)"></ellipse><path
                  d="M12 0C6.48 0 2 4.48 2 10c0 7.5 10 20 10 20s10-12.5 10-20c0-5.52-4.48-10-10-10z"
                  fill="oklch(58% 0.22 20)"></path><circle cx="12" cy="10" r="4" fill="oklch(75% 0.15 20)"
                ></circle></svg
              >
            </div>
            <div class="mmv__map-marker mmv__map-marker--target absolute w-[18px] h-6 opacity-0 will-change-transform sm:w-5 sm:h-[26px]" style="top: 55%; left: 48%;" data-name="Marcus Rivera">
              <svg class="w-full h-full" viewBox="0 0 24 32" fill="none" xmlns="http://www.w3.org/2000/svg"
                ><ellipse cx="12" cy="30" rx="5" ry="2" fill="oklch(0% 0 0 / 0.3)"></ellipse><path
                  d="M12 0C6.48 0 2 4.48 2 10c0 7.5 10 20 10 20s10-12.5 10-20c0-5.52-4.48-10-10-10z"
                  fill="oklch(58% 0.22 20)"></path><circle cx="12" cy="10" r="4" fill="oklch(75% 0.15 20)"
                ></circle></svg
              >
            </div>
            <div class="mmv__map-marker absolute w-[18px] h-6 opacity-0 will-change-transform sm:w-5 sm:h-[26px]" style="top: 28%; left: 70%;" data-name="Tina Park">
              <svg class="w-full h-full" viewBox="0 0 24 32" fill="none" xmlns="http://www.w3.org/2000/svg"
                ><ellipse cx="12" cy="30" rx="5" ry="2" fill="oklch(0% 0 0 / 0.3)"></ellipse><path
                  d="M12 0C6.48 0 2 4.48 2 10c0 7.5 10 20 10 20s10-12.5 10-20c0-5.52-4.48-10-10-10z"
                  fill="oklch(58% 0.22 20)"></path><circle cx="12" cy="10" r="4" fill="oklch(75% 0.15 20)"
                ></circle></svg
              >
            </div>
            <div class="mmv__map-marker absolute w-[18px] h-6 opacity-0 will-change-transform sm:w-5 sm:h-[26px]" style="top: 65%; left: 25%;" data-name="Layla Okonkwo">
              <svg class="w-full h-full" viewBox="0 0 24 32" fill="none" xmlns="http://www.w3.org/2000/svg"
                ><ellipse cx="12" cy="30" rx="5" ry="2" fill="oklch(0% 0 0 / 0.3)"></ellipse><path
                  d="M12 0C6.48 0 2 4.48 2 10c0 7.5 10 20 10 20s10-12.5 10-20c0-5.52-4.48-10-10-10z"
                  fill="oklch(58% 0.22 20)"></path><circle cx="12" cy="10" r="4" fill="oklch(75% 0.15 20)"
                ></circle></svg
              >
            </div>
          </div>
          <!-- Map popup -->
          <div class="mmv__popup mmv__popup--map absolute bottom-0 left-0 right-0 opacity-0 z-[5] py-6 px-[18px] rounded-b-[34px] pb-12 sm:py-7 sm:px-[22px] sm:rounded-b-[39px]">
            <div class="mmv__popup-contact flex gap-[10px] items-start">
              <span class="mmv__tl-avatar w-[30px] h-[30px] rounded-full text-amber-400 grid place-content-center text-[0.65rem] font-bold shrink-0 sm:w-[34px] sm:h-[34px] sm:text-[0.7rem]">M</span>
              <div class="mmv__popup-info flex flex-col gap-[3px]">
                <span class="mmv__popup-name text-[0.75rem] font-semibold text-stone-100 sm:text-[0.8rem]">Marcus Rivera</span>
                <span class="mmv__popup-detail text-[0.6rem] text-stone-400 sm:text-[0.65rem]">Designer at Figma</span>
                <span class="mmv__popup-location text-[0.6rem] text-stone-500 flex items-center gap-1 sm:text-[0.65rem]">
                  <svg class="w-[10px] h-[10px] shrink-0 sm:w-3 sm:h-3" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"
                    ><path d="M13 6.5c0 4.5-5 8-5 8s-5-3.5-5-8a5 5 0 0 1 10 0z" stroke="currentColor" stroke-width="1.2"
                    ></path><circle cx="8" cy="6.5" r="1.5" stroke="currentColor" stroke-width="1.2"></circle></svg
                  >
                  Met at Union Square
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== TAB BAR ===== -->
      <div class="mmv__tabbar absolute bottom-0 left-0 right-0 flex justify-around items-center pt-2 pb-4 z-[6] sm:pt-[10px] sm:pb-5">
        <button class="mmv__tabbar-btn bg-none border-none p-[6px] text-stone-500 cursor-pointer active" data-tab="timeline" aria-label="Timeline">
          <svg class="w-[18px] h-[18px] sm:w-5 sm:h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
            ><path
              d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"
              stroke="currentColor"
              stroke-width="1.5"
              stroke-linecap="round"></path></svg
          >
        </button>
        <button class="mmv__tabbar-btn bg-none border-none p-[6px] text-stone-500 cursor-pointer" data-tab="calendar" aria-label="Calendar">
          <svg class="w-[18px] h-[18px] sm:w-5 sm:h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
            ><rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="1.5"></rect><path
              d="M16 2v4M8 2v4M3 10h18"
              stroke="currentColor"
              stroke-width="1.5"
              stroke-linecap="round"></path></svg
          >
        </button>
        <button class="mmv__tabbar-btn bg-none border-none p-[6px] text-stone-500 cursor-pointer" data-tab="map" aria-label="Map">
          <svg class="w-[18px] h-[18px] sm:w-5 sm:h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
            ><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" stroke="currentColor" stroke-width="1.5"
            ></path><circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="1.5"></circle></svg
          >
        </button>
      </div>
    </PhoneFrame>

    <!-- Feature explanation cards (below phone on mobile, left column on desktop) -->
    <div class="mmv__features">
      <div class="mmv__features-track flex flex-col gap-3 max-md:flex-row max-md:gap-4">
        <div class="mmv__feature mmv__feature--active rounded-[12px] border border-stone-700 bg-transparent py-[14px] px-[18px] max-md:flex-[0_0_75%] max-md:min-w-0" data-view="timeline">
          <span class="mmv__feature-title block text-base font-bold text-stone-200 mb-1">Timeline</span>
          <span class="mmv__feature-desc block text-[0.85rem] leading-[1.5] text-stone-500">Scroll through everyone you've met, organized by when you met them.</span>
        </div>
        <div class="mmv__feature rounded-[12px] border border-stone-700 bg-transparent py-[14px] px-[18px] max-md:flex-[0_0_75%] max-md:min-w-0" data-view="calendar">
          <span class="mmv__feature-title block text-base font-bold text-stone-200 mb-1">Calendar</span>
          <span class="mmv__feature-desc block text-[0.85rem] leading-[1.5] text-stone-500"
            >See which days you met new people. Tap any date for details and birthdays.</span
          >
        </div>
        <div class="mmv__feature rounded-[12px] border border-stone-700 bg-transparent py-[14px] px-[18px] max-md:flex-[0_0_75%] max-md:min-w-0" data-view="map">
          <span class="mmv__feature-title block text-base font-bold text-stone-200 mb-1">Map</span>
          <span class="mmv__feature-desc block text-[0.85rem] leading-[1.5] text-stone-500">See where you've met people pinned on a map. Tap to recall the context.</span>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  import { animate, stagger, inView } from 'motion'

  const EASE = [0.25, 1, 0.5, 1] as const
  const EXIT_EASE = [0.5, 0, 0.75, 0] as const
  const VIEWS = ['timeline', 'calendar', 'map']

  let abortController: AbortController | null = null

  function delay(ms: number, signal: AbortSignal): Promise<void> {
    return new Promise((resolve, reject) => {
      const id = setTimeout(resolve, ms)
      signal.addEventListener('abort', () => {
        clearTimeout(id)
        reject(new DOMException('Aborted', 'AbortError'))
      })
    })
  }

  function showGate(viewName: string) {
    document.querySelectorAll('.mmv__gate').forEach((g) => {
      ;(g as HTMLElement).style.display = (g as HTMLElement).dataset.gate === viewName ? '' : 'none'
    })
  }

  function hideAllGates() {
    document.querySelectorAll('.mmv__gate').forEach((g) => {
      ;(g as HTMLElement).style.display = 'none'
    })
  }

  function animateMobileCarousel(viewName: string, instant = false) {
    const track = document.querySelector('.mmv__features-track') as HTMLElement
    const container = document.querySelector('.mmv__features') as HTMLElement
    if (!track || !container || getComputedStyle(container).overflow !== 'hidden') return

    const viewIndex = VIEWS.indexOf(viewName)
    if (viewIndex === -1) return

    const cards = track.querySelectorAll('.mmv__feature')
    if (cards.length === 0) return

    const card = cards[viewIndex] as HTMLElement
    const containerWidth = container.offsetWidth
    const targetX = -(card.offsetLeft - (containerWidth - card.offsetWidth) / 2)

    if (instant) {
      animate(track, { x: targetX } as any, { duration: 0 } as any)
    } else {
      animate(track, { x: targetX } as any, { duration: 0.5, easing: [...EASE] } as any)
    }
  }

  function initViewsAnimation() {
    const section = document.querySelector('.mmv')
    if (!section) return

    animateMobileCarousel('timeline', true)

    window.addEventListener('resize', () => {
      const activeCard = document.querySelector('.mmv__features .mmv__feature--active') as HTMLElement
      if (activeCard) {
        animateMobileCarousel(activeCard.dataset.view || 'timeline', true)
      }
    })

    inView(
      section,
      () => {
        startAnimation()
      },
      { amount: 0.3 },
    )
  }

  function startAnimation() {
    if (abortController) abortController.abort()
    abortController = new AbortController()
    runViewsAnimation(abortController.signal)
  }

  function setActiveView(viewName: string) {
    // Update feature cards
    document.querySelectorAll('.mmv__feature').forEach((card) => {
      card.classList.toggle('mmv__feature--active', (card as HTMLElement).dataset.view === viewName)
    })
    // Update tabbar buttons
    document.querySelectorAll('.mmv__tabbar-btn').forEach((btn) => {
      btn.classList.toggle('active', (btn as HTMLElement).dataset.tab === viewName)
    })
    // Animate mobile carousel
    animateMobileCarousel(viewName)
  }

  async function runViewsAnimation(signal: AbortSignal) {
    const phone = document.querySelector('.mmv .phone-frame__phone') as HTMLElement

    // Timeline elements
    const tlView = document.querySelector('.mmv__view--timeline') as HTMLElement
    const tlScroll = document.querySelector('.mmv__tl-scroll-wrap') as HTMLElement
    const allTlElements = document.querySelectorAll('.mmv__tl-header, .mmv__tl-row')

    // Calendar elements
    const calView = document.querySelector('.mmv__view--calendar') as HTMLElement
    const calScroll = document.querySelector('.mmv__cal-scroll-wrap') as HTMLElement
    const calPopup = document.querySelector('.mmv__popup--cal') as HTMLElement
    const calSelectDay = document.querySelector('.mmv__cal-day[data-select]') as HTMLElement

    // Map elements
    const mapView = document.querySelector('.mmv__view--map') as HTMLElement
    const mapContainer = document.querySelector('.mmv__map-container') as HTMLElement
    const mapMarkers = document.querySelectorAll('.mmv__map-marker')
    const mapTarget = document.querySelector('.mmv__map-marker--target') as HTMLElement
    const mapPopup = document.querySelector('.mmv__popup--map') as HTMLElement

    if (!phone || !tlView || !calView || !mapView) return

    try {
      // Hide all gates at the start of each cycle
      hideAllGates()

      // ===== TIMELINE =====
      setActiveView('timeline')
      showGate('timeline')
      tlView.style.opacity = ''
      tlScroll.scrollTop = 0

      // Stagger in rows and headers
      allTlElements.forEach((el) => ((el as HTMLElement).style.opacity = '0'))
      await animate(
        allTlElements,
        { opacity: [0, 1], x: [-10, 0] } as any,
        { duration: 0.35, delay: stagger(0.06), easing: [...EASE] } as any,
      ).finished
      if (signal.aborted) return

      await delay(800, signal)

      // Scroll using scrollTop
      const tlScrollTarget = 420
      await animate(0, tlScrollTarget, {
        duration: 2,
        easing: [0.4, 0, 0.2, 1] as any,
        onUpdate: (v: number) => {
          tlScroll.scrollTop = v
        },
      } as any).finished
      if (signal.aborted) return

      await delay(1500, signal)

      // Fade out timeline then hide gate
      await animate(tlView, { opacity: 0 } as any, { duration: 0.4, easing: [...EXIT_EASE] } as any).finished
      if (signal.aborted) return
      hideAllGates()

      // ===== CALENDAR =====
      setActiveView('calendar')

      // Reset calendar state before showing
      calScroll.scrollTop = 0
      calSelectDay?.classList.remove('mmv__cal-day--selected')
      calPopup.style.opacity = '0'
      calPopup.style.transform = 'translateY(100%)'

      // Show calendar
      showGate('calendar')
      await animate(calView, { opacity: [0, 1] } as any, { duration: 0.4, easing: [...EASE] } as any).finished
      if (signal.aborted) return

      await delay(600, signal)

      // Scroll to reveal March using scrollTop
      const calScrollTarget = 400
      await animate(0, calScrollTarget, {
        duration: 1.8,
        easing: [0.4, 0, 0.2, 1] as any,
        onUpdate: (v: number) => {
          calScroll.scrollTop = v
        },
      } as any).finished
      if (signal.aborted) return

      await delay(500, signal)

      // Select March 16
      if (calSelectDay) {
        calSelectDay.classList.add('mmv__cal-day--selected')
      }
      await delay(400, signal)

      // Popup slides up
      await animate(
        calPopup,
        { opacity: [0, 1], y: ['100%', '0%'] } as any,
        { duration: 0.5, easing: [...EASE] } as any,
      ).finished
      if (signal.aborted) return

      await delay(2000, signal)

      // Fade out calendar then hide gate
      animate(calPopup, { opacity: 0, y: '100%' } as any, { duration: 0.35, easing: [...EXIT_EASE] } as any)
      await animate(calView, { opacity: 0 } as any, { duration: 0.4, easing: [...EXIT_EASE] } as any).finished
      if (signal.aborted) return
      hideAllGates()

      // ===== MAP =====
      setActiveView('map')

      // Reset map state before showing
      mapContainer.style.transform = ''
      mapPopup.style.opacity = '0'
      mapPopup.style.transform = 'translateY(100%)'
      mapTarget?.classList.remove('mmv__map-marker--pulse')
      mapMarkers.forEach((m) => ((m as HTMLElement).style.opacity = '0'))

      // Show map
      showGate('map')
      await animate(mapView, { opacity: [0, 1] } as any, { duration: 0.4, easing: [...EASE] } as any).finished
      if (signal.aborted) return

      // Fade in markers
      await animate(
        mapMarkers,
        { opacity: [0, 1], scale: [0.5, 1] } as any,
        { duration: 0.3, delay: stagger(0.08), easing: [...EASE] } as any,
      ).finished
      if (signal.aborted) return

      // Map pan
      animate(mapContainer, { x: [0, -45], y: [0, -35] } as any, { duration: 3.5, easing: [0.16, 1, 0.3, 1] } as any)

      await delay(1500, signal)

      // Pulse target marker
      if (mapTarget) {
        mapTarget.classList.add('mmv__map-marker--pulse')
      }
      await delay(800, signal)

      // Map popup slides up
      await animate(
        mapPopup,
        { opacity: [0, 1], y: ['100%', '0%'] } as any,
        { duration: 0.5, easing: [...EASE] } as any,
      ).finished
      if (signal.aborted) return

      await delay(2000, signal)

      // Fade out map then hide gate
      animate(mapPopup, { opacity: 0, y: '100%' } as any, { duration: 0.35, easing: [...EXIT_EASE] } as any)
      await animate(mapView, { opacity: 0 } as any, { duration: 0.4, easing: [...EXIT_EASE] } as any).finished
      if (signal.aborted) return
      hideAllGates()

      await delay(600, signal)

      // Loop
      runViewsAnimation(signal)
    } catch (e) {
      if (e instanceof DOMException && e.name === 'AbortError') return
      throw e
    }
  }

  document.addEventListener('astro:page-load', initViewsAnimation)
</script>

<style>
  .mmv__content {
    @media (width >= 48rem) {
      display: grid;
      grid-template-columns: minmax(0, 22rem) auto;
      grid-template-rows: 1fr auto auto 1fr;
      gap: 0 4rem;
      justify-content: center;
    }
  }

  .mmv__text {
    @media (width >= 48rem) {
      grid-column: 1;
      grid-row: 2;
    }
  }

  .mmv__features {
    @media (width >= 48rem) {
      grid-column: 1;
      grid-row: 3;
    }

    @media (width < 48rem) {
      overflow: hidden;
      margin-left: -2rem;
      margin-right: -2rem;
      mask-image: linear-gradient(to right, transparent 0%, black 15%, black 85%, transparent 100%);
    }
  }

  .mmv__feature {
    transition:
      background 0.5s cubic-bezier(0.25, 1, 0.5, 1),
      border-color 0.5s cubic-bezier(0.25, 1, 0.5, 1);
  }

  .mmv__feature--active {
    border-color: var(--color-amber-500);
    background: linear-gradient(
      135deg,
      color-mix(in oklch, var(--color-amber-500) 12%, transparent) 0%,
      color-mix(in oklch, var(--color-amber-500) 4%, transparent) 100%
    );
  }

  .mmv__feature-title {
    transition: color 0.5s cubic-bezier(0.25, 1, 0.5, 1);

    .mmv__feature--active & {
      color: var(--color-amber-400);
    }
  }

  .mmv__feature-desc {
    transition: color 0.5s cubic-bezier(0.25, 1, 0.5, 1);

    .mmv__feature--active & {
      color: var(--color-stone-300);
    }
  }

  /* ── Phone frame overrides ── */
  .mmv__content :global(.phone-frame) {
    display: flex;
    flex-direction: column;
    align-items: center;

    @media (width >= 48rem) {
      grid-column: 2;
      grid-row: 1 / -1;
    }
  }

  .mmv__tl-scroll-wrap,
  .mmv__cal-scroll-wrap {
    &::-webkit-scrollbar {
      display: none;
    }
  }

  .mmv__tl-header {
    background: var(--color-stone-900);
    background: linear-gradient(
      90deg,
      var(--color-stone-900) 40%,
      color-mix(in oklch, var(--color-stone-900) 0%, transparent) 100%
    );
  }

  .mmv__tl-row {
    & + & {
      border-top: 1px solid color-mix(in oklch, var(--color-stone-800) 40%, transparent);
    }
  }

  .mmv__tl-avatar {
    background: color-mix(in oklch, var(--color-amber-500) 15%, transparent);
  }

  .mmv__cal-month-label {
    background: var(--color-stone-900);
    background: linear-gradient(
      90deg,
      var(--color-stone-900) 40%,
      color-mix(in oklch, var(--color-stone-900) 0%, transparent) 100%
    );
  }

  .mmv__cal-weekdays span {
    font-size: 0.48rem;
    font-weight: 600;
    color: var(--color-stone-500);
    text-transform: uppercase;
    padding: 2px 0;

    @media (width >= 40rem) {
      font-size: 0.52rem;
    }
  }

  .mmv__cal-day {
    font-size: 0.55rem;
    color: var(--color-stone-300);
    padding: 5px 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    position: relative;

    @media (width >= 40rem) {
      font-size: 0.6rem;
      padding: 6px 0;
    }

    &--empty {
      visibility: hidden;
    }

    &--event::after {
      content: '';
      width: 3px;
      height: 3px;
      border-radius: 50%;
      background: oklch(65% 0.2 15);
    }

    &--selected {
      color: var(--color-stone-50);
      font-weight: 700;

      &::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -55%);
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: oklch(50% 0.15 260);
        z-index: -1;

        @media (width >= 40rem) {
          width: 22px;
          height: 22px;
        }
      }
    }
  }

  /* ── Shared Popup ── */
  .mmv__popup {
    background: linear-gradient(180deg, oklch(20% 0.02 50 / 0) 0%, var(--color-stone-900) 20%);
    transform: translateY(100%);
  }

  .mmv__popup-dot--bday {
    background: oklch(65% 0.2 15);
  }

  /* ── Map ── */
  .mmv__view--map {
    background: oklch(18% 0.006 50);
  }

  .mmv__map-marker {
    filter: drop-shadow(0 2px 4px oklch(0% 0 0 / 0.4));
  }

  .mmv__map-marker--pulse {
    animation: marker-pulse 0.6s ease-out forwards;
    transform-origin: center bottom;
  }

  @keyframes marker-pulse {
    0% {
      transform: scale(1);
    }
    30% {
      transform: scale(1.6);
    }
    60% {
      transform: scale(1.2);
    }
    100% {
      transform: scale(1.4);
    }
  }

  .mmv__tabbar {
    background: linear-gradient(transparent, var(--color-stone-950) 100%);
  }

  .mmv__tabbar-btn {
    transition: color 0.3s ease;

    &.active {
      color: var(--color-amber-400);
    }
  }
</style>
